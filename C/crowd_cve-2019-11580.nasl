#TRUSTED 6f729eeb0b631f29f61528c423f7ec5a93d4b0afc791e4d4c4b58141626811f75e4353fb4630527672103ff47f905ae471d77d0f134111256452e62cf2bdb10ccf042c8083311a88a76bd9237d7e01a690dd1a3824eb070b90edbcfdc4c8c21224df40f2d714bf04ba8ec97c082da6a6dd3262657956fe92e1f9e8f8414fa5ee9a8e42191ed5ab3648c4676005ce689a7c28e0caa0cee92f6b5646326f1b2c3564f437c1a9d332a2f0f3aeef2cf8b594858d7cfac9ae7dc438ce007e932ac4470ef2a8718b50de16a71e8a3409ed3ae53c13fa94ae6a422772d6a466f35a8e345e82bb38b2788448211e1bba39c6a4cd16140e6a26309a52e11fdb44521730d2a3380317afeea12bfe2f1cd23567ef1e338a4b850f9566be11748eb398feea69ad87f5c38ccd5f75369935f30cfc5a81097fdd8435aec9e160779010bb47e78cd1705fa921dd9205698af6292b51c1a2d1fec977b3a852011ca2fe57254ddcf14ba923d8322df0510cfbf8059b3f5633d678314921410d6a6e4eb3167b5b0d3a7df2a2142ba19eb5a56f458bf0e6fbf869d53e6f3217af6463e3889ae1c0164c6c571d94816e9ecdffdf96015e905e23ee22e9ae93648c3271be24816c22f1af1c52c22b4a8cf3d572ba18f11a1a27a011573aa086c42727803075c4ffa9164690078567c7cb264884b9b4f49552d2ec48f1c10b423bd8e7cfb1dc3f6268df1b
#TRUST-RSA-SHA256 ab8710d5ae60f23e24cb87038d7b1f5e38b91d715ee47f169afca1d4e7cc5ed1b79b3892bcdc3567bb329fd89bca5511ff3f5cc3c8d39aa4434daa75413a21dc6ed3b4915dc11af36719afa84e9790dc7a13d09276083aeffd40c083ff27138b2203465cbd803a38bbff99227b128c5e22355948193284ada4ea3be416a149ffa518ef65ce5c5c650c91ea35923a2e32976295f8c48b47f170b7077b8b2bd165828019780efdde467e7f0d2497a0a1b8fdd93eb547fdff4336b8f28c3762d4d3dcbb63e7b9f7c9567c2186bb1081d46b160353a9643ef71a11a5385fe5e5e15c99fa1d24bc2d052c7922143a7ba6d5cb50e90abd541ae53dda1b98a478376f99593c035631cb68369a78e88db84f0087dc1dc497440ab4dc8fb95644196c631b271af42cfaa1d1282c919adfb7ffca79a6e5748ac64ad6ab6d34c9c884a92e6aeeca2fb42d0a7d2e6ce8f599b9a23b70a77e0eb05855402ea482d003d99c11f3964337a77ca9e3b8a9317ab4642d00cec10aed585c8388c7693550247a1f786f36c7c43413e4dc4b1859b2c37aa46419104bbe009426ba1a900d37517988426eca246065261c87da67c98dbce44648049576dd0b32965f27e60e27e4daeea0c885c79540843b00f216641e28e7f185a66b452a12196da47b9abc9eaec5aed13a4ecd67f8495a87e44c389b51240b620d51f70ca7d02da4ed62de5519bc71a17d
#%NASL_MIN_LEVEL 70300
#
# (C) Tenable Network Security, Inc.
#

include('deprecated_nasl_level.inc');
include('compat.inc');

if (description)
{
  script_id(138553);
  script_version("1.22");
  script_set_attribute(attribute:"plugin_modification_date", value:"2022/12/05");

  script_cve_id("CVE-2019-11580");
  script_bugtraq_id(108637);
  script_xref(name:"IAVA", value:"2020-A-0499-S");
  script_xref(name:"CISA-KNOWN-EXPLOITED", value:"2022/05/03");
  script_xref(name:"CEA-ID", value:"CEA-2020-0129");
  script_xref(name:"CEA-ID", value:"CEA-2019-0571");

  script_name(english:"Atlassian Crowd 2.1.x < 3.0.5 / 3.1.x < 3.1.6 / 3.2.x < 3.2.8 / 3.3.x < 3.3.5 / 3.4.x < 3.4.4 RCE (direct check)");

  script_set_attribute(attribute:"synopsis", value:
"The version of Atlassian Crowd installed on the remote host is affected by a remote code execution (RCE) vulnerability.");
  script_set_attribute(attribute:"description", value:
"The version of Atlassian Crowd installed on the remote host is affected by a remote code execution (RCE) vulnerability.
An unauthenticated, remote attacker can exploit this, by using pdkinstall development plugin, to install arbitrary
plugins, which permits remote code execution.");
  # https://confluence.atlassian.com/crowd/crowd-security-advisory-2019-05-22-970260700.html
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?f66fbb1c");
  script_set_attribute(attribute:"see_also", value:"https://www.corben.io/atlassian-crowd-rce/");
  script_set_attribute(attribute:"solution", value:
"Upgrade to version 3.0.5, 3.1.6, 3.2.8, 3.3.5, 3.4.4 or later.");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:P/I:P/A:P");
  script_set_cvss_temporal_vector("CVSS2#E:H/RL:OF/RC:C");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H");
  script_set_cvss3_temporal_vector("CVSS:3.0/E:H/RL:O/RC:C");
  script_set_attribute(attribute:"cvss_score_source", value:"CVE-2019-11580");

  script_set_attribute(attribute:"exploitability_ease", value:"Exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"true");
  script_set_attribute(attribute:"exploit_framework_core", value:"true");
  script_set_attribute(attribute:"exploited_by_malware", value:"true");
  script_set_attribute(attribute:"exploited_by_nessus", value:"true");
  script_set_attribute(attribute:"metasploit_name", value:'Atlassian Crowd pdkinstall Unauthenticated Plugin Upload RCE');
  script_set_attribute(attribute:"exploit_framework_metasploit", value:"true");

  script_set_attribute(attribute:"vuln_publication_date", value:"2019/05/22");
  script_set_attribute(attribute:"patch_publication_date", value:"2019/05/22");
  script_set_attribute(attribute:"plugin_publication_date", value:"2020/07/16");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:atlassian:crowd");
  script_set_attribute(attribute:"stig_severity", value:"I");
  script_set_attribute(attribute:"thorough_tests", value:"true");
  script_end_attributes();

  script_category(ACT_ATTACK);
  script_family(english:"CGI abuses");

  script_copyright(english:"This script is Copyright (C) 2020-2022 and is owned by Tenable, Inc. or an Affiliate thereof.");

  script_dependencies("crowd_detect.nasl");
  script_require_keys("www/crowd");
  script_require_ports("Services/www", 8095);

  exit(0);
}

include('http.inc');
include('install_func.inc');

appname = 'Atlassian Crowd';
app_id  = 'crowd';

# Exit if app is not detected on the target
get_install_count(app_name:app_id, exit_if_zero:TRUE);

port = get_http_port(default:8095);
install = get_single_install(app_name:app_id, webapp:TRUE, port:port);

base_path = install['path'];
url = '/admin/uploadplugin.action';

res = http_send_recv3(
  method : 'POST',
  port   : port,
  item   : base_path + url,
  exit_on_fail : TRUE
);

if ('400' >< res[0] && ('Unable to install plugin' >< res[2] || 'All plugins could not be validated' >< res[2]))
{
  security_report_v4(
    port        : port,
    severity    : SECURITY_HOLE,
    generic     : TRUE,
    request     : make_list(http_last_sent_request()),
    output      : res[0] + res[2]
  );
}
else
{
  audit(AUDIT_WEB_APP_NOT_AFFECTED, appname, build_url(qs:install['path'], port:port));
}


