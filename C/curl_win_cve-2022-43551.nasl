#%NASL_MIN_LEVEL 80900
##
# (C) Tenable, Inc.
##

include('compat.inc');

if (description)
{
  script_id(171858);
  script_version("1.2");
  script_set_attribute(attribute:"plugin_modification_date", value:"2023/02/27");

  script_cve_id("CVE-2022-43551");
  script_xref(name:"IAVA", value:"2023-A-0008-S");

  script_name(english:"Curl Cleartext Information Disclosure < 7.87 (CVE-2022-43551)");

  script_set_attribute(attribute:"synopsis", value:
"The remote Windows host has a program that is affected by an information disclosure vulnerability.");
  script_set_attribute(attribute:"description", value:
"The version of Curl installed on the remote host is prior to 7.87.0. It is therefore affected by an information 
disclosure vulnerability where the HSTS mechanism could be bypassed to trick curl to keep using HTTP.
Using its HSTS support, curl can be instructed to use HTTPS instead of using an insecure clear-text HTTP step even
when HTTP is provided in the URL. However, the HSTS mechanism could be bypassed if the host name in the given URL
first uses IDN characters that get replaced to ASCII counterparts as part of the IDN conversion. Like using the
character UTF-8 U+3002 (IDEOGRAPHIC FULL STOP) instead of the common ASCII full stop (U+002E) `.`. Then in a
subsequent request, it does not detect the HSTS state and makes a clear text transfer. Because it would store
the info IDN encoded but look for it IDN decoded.

Note that Nessus has not tested for this issue but has instead relied only on the application's self-reported version
number.");
  script_set_attribute(attribute:"see_also", value:"https://curl.se/docs/CVE-2022-43551.html");
  script_set_attribute(attribute:"solution", value:
"Upgrade Curl to version 7.87.0 or later");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:C/I:N/A:N");
  script_set_cvss_temporal_vector("CVSS2#E:U/RL:OF/RC:C");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N");
  script_set_cvss3_temporal_vector("CVSS:3.0/E:U/RL:O/RC:C");
  script_set_attribute(attribute:"cvss_score_source", value:"CVE-2022-43551");

  script_set_attribute(attribute:"exploitability_ease", value:"No known exploits are available");

  script_set_attribute(attribute:"vuln_publication_date", value:"2022/12/21");
  script_set_attribute(attribute:"patch_publication_date", value:"2022/12/21");
  script_set_attribute(attribute:"plugin_publication_date", value:"2023/02/23");

  script_set_attribute(attribute:"potential_vulnerability", value:"true");
  script_set_attribute(attribute:"plugin_type", value:"local");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:haxx:curl");
  script_set_attribute(attribute:"stig_severity", value:"I");
  script_set_attribute(attribute:"thorough_tests", value:"true");
  script_end_attributes();

  script_category(ACT_GATHER_INFO);
  script_family(english:"Windows");

  script_copyright(english:"This script is Copyright (C) 2023 and is owned by Tenable, Inc. or an Affiliate thereof.");

  script_dependencies("curl_win_installed.nbin");
  script_require_keys("installed_sw/Curl", "SMB/Registry/Enumerated");

  exit(0);
}

include('vcf.inc');

var app_info = vcf::get_app_info(app:'Curl', win_local:TRUE);

# curl built without IDN support is not vulnerable
if (report_paranoia < 2)
  audit(AUDIT_PARANOID);

var constraints = [{'min_version': '7.77.0', 'max_version': '7.86.0', 'fixed_version' : '7.87.0' }];

vcf::check_version_and_report(app_info:app_info, constraints:constraints, severity:SECURITY_HOLE);